---
title: "Vignette_3: Data Inference with CLL human study: UM vs M subtypes"
output:
  html_document:
    theme: united
    toc: yes
vignette: "%\\VignetteIndexEntry{Vignette} \n%\\VignetteEngine{knitr::rmarkdown} \n%\\VignetteEncoding{UTF-8}\n"
editor_options: 
  markdown: 
    wrap: 72
---

```{=html}
<style type="text/css">
.main-container {
  max-width: 1800px;
  margin-left: auto;
  margin-right: auto;
}
body{ /* Normal  */
      font-size: 18px;
  }
code.r{ /* Code block */
    font-size: 14px;
}
</style>
```

```{r, include = FALSE}
#https://bookdown.org/yihui/rmarkdown/html-document.html
#https://stackoverflow.com/questions/30446905/rmarkdown-font-size-and-header
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  knitr::opts_chunk$set(warning = FALSE, message = TRUE)
)
```
# StellarPath
Welcome to the third vignette of our software StellarPath. 

* This vignette focuses on inferring the class of new patients after that StellarPath has been trained with previous ones.
* This vignette is useful when you trained and tested StellarPath on a known dataset and you want to use the predictive markers to predict the class of the patients described in a external dataset.

## Note
Before checking this vignette, we suggest to go through the first and second vignette describing the main workflow.
This vignette is advanced, we will skip the explanations about operations and data, we will focus on the inference operation and results only.

## Case study
For this vignette, StellarPath is applied on a simple experimental study:

* We have: Chronic lymphocytic leukemia (CLL) patient's samples divided into unmutated (UM-CLL) and mutated (M-CLL)
* We have: Four indipendent RNA sequencing datasets
* We want: Find deregulated molecules, pathways and predictive pathways-specific PSNs between UM-CLL and M-CLL patients in one known dataset
* We want: Use the predictive pathways-specific PSNs to predict the class of CLL patients described in three new datasets coming from indipendent studies

# Enviroment set up
Let us clean the R enviroment, set the working directory, load the software package, set the random seed generator for reproducing always the same results and define the number of cores available in the computer to run the operations.

* Be careful: set up the number of cores based on your resources, if you are not secure how to, then just set equal to 2

```{r setup}

#Clean workspace and memory ----
rm(list=ls())
gc()

#Set working directory ----
gps0=getwd()
gps0=paste(gps0,"/%s",sep="")
rootDir=gps0
setwd(gsub("%s","",rootDir))
set.seed(5)

#Load libraries ----
library("StellarPath")
library("qs")
library("data.table")
library("ggplot2")
library("plyr")
library("ggpubr")
library("writexl")

#Set variables ----
#Input
#Set the number of cores available in the system
n_cores=15
#output
#Set the output file where all the data and results will be stored in the end
out_res_path="classif_CLL.qs"
out_plot_path="classif_CLL.pdf"
out_perfs_path="classif_CLL.xlsx"
```

# Training and Testing
For this vignette, we load CLL data that StellarPath includes in the package. 
Chronic lymphocytic leukemia (CLL) is divided into unmutated (UM-CLL) and mutated (M-CLL) subtypes depending on the frequency of somatic hypermutation (SHM) in their immunoglobulin heavy chain V (IGHV) region. 

Here, we train and test StellarPath on the largest CLL dataset.
We run the main workflow based on cross-validation.

```{r workflow}
#Load and set up the example data ----
data(cll_l)
counts4=cll_l[[4]]$counts
info4_df=cll_l[[4]]$info

#Set name of the project, the specie id of the samples, the name of the classes to compare (case vs control)
name_dataset="UMvsM"
tax_id=9606
groups=c("UM","M")

data_l=prepare_data(info = info4_df[,c(1,2)],
                    groups_name = groups,
                    gex = counts4,
                    tax_id = tax_id,
                    n_cores = n_cores);tmp=gc();

#Find the pathways that in the training data produce a significant PSN
data_l=analyse_training(data_l)

#Classify the testing patients based on the features/pathways learnt from the training
data_l=classify_testing(data_l)

#Retrieve best pathways/target sets and their PSNs used in the classification
data_l=enrichment_analysis(data_l)
qsave(data_l,file=out_res_path,nthreads = 15)
```

# Training results

We have a look to the predictive and significant pathways/PSNs found between UM and M classes.

In the context of Chronic Lymphocytic Leukemia (CLL), the unmutated subtype (UM-CLL) has been shown to exhibit a more aggressive phenotype compared to the mutated subtype (M-CLL) [1, 2, 3, 4, 5]. The activation of pathways such as Natural killer cell mediated cytotoxicity, B Cell Receptor Signaling, Focal Adhesion, and Negative Regulation of Cell-Cell Adhesion in UM-CLL reflect this aggressive nature. Specifically, the activation of immune-related pathways is associated to the intense inflammatory state, contributing to the aggressive behavior of UM-CLL cells [1, 2]. The increased cell mobility suggested by the activation of Focal Adhesion and Negative Regulation of Cell-Cell Adhesion pathways contribute to a more invasive and spreading phenotype [3, 4]. Conversely, the inhibition of TNFA signaling via NFkB in UM-CLL might represent a counter-regulatory mechanism. These molecular insights, supported by recent literature, provide a comprehensive understanding of the UM-CLL nature compared to the one of the M-CLL subtype and highlight StellarPath ability to find meaningful biological results.

[1] https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7810248/
[2] https://www.ncbi.nlm.nih.gov/pmc/articles/PMC9739887/
[3] https://www.ncbi.nlm.nih.gov/pmc/articles/PMC8024566/
[4] https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6924557/
[5] https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7010256/

Further on, we can also positively notice that StellarPath found the B Cell Receptor (BCR) Signaling pathway activated.

In the context of Chronic Lymphocytic Leukemia (CLL), particularly the most aggressive unmutated subtype (UM-CLL), the B Cell Receptor (BCR) Signaling pathway plays a key role [6, 7, 8, 9, 10, 11]. Differently from normal B cells, CLL's BCR signaling is characterized by low-level IgM expression, variable antigen response, and deregulation, contributing to the disease development [6, 11]. Elevated BCR signaling activity in CLL cells promotes survival and proliferation, and prognostic markers such as IgVH mutational status, ZAP-70, and CCL3 are associated with enhanced BCR signaling, suggesting a relationship with worse prognosis [7, 11]. 

[6] https://ashpublications.org/blood/article/120/6/1175/30492/The-B-cell-receptor-signaling-pathway-as-a
[7] https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4077074/
[8] https://ashpublications.org/blood/article/118/16/4313/28862/B-cell-receptor-signaling-in-chronic-lymphocytic
[9] https://pubmed.ncbi.nlm.nih.gov/23928062/
[10] https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3898793/
[11] https://www.cell.com/cell-reports/pdf/S2211-1247(19)30849-6.pdf


```{r cv resulting pathways, results='asis'}
paths_df=data_l$enrichment$pathway_analysis$top_pathways_df
knitr::kable(paths_df[,1:9])
#write.table(paths_df$pathways[paths_df$regulation=="activated" & paths_df$group==groups[1]],
#            file = "UM_act.txt",quote = FALSE,row.names = FALSE,col.names = FALSE)
#write.table(paths_df$pathways[paths_df$regulation!="activated" & paths_df$group==groups[1]],
#            file = "UM_inh.txt",quote = FALSE,row.names = FALSE,col.names = FALSE)

```
```{r plot cv resulting pathways, results='asis', out.width = "100%", fig.align = "center", message=FALSE}
x=data_l$enrichment$pathway_analysis$top_pathways_df
x=unique(x[order(x$power),1:12])
x$pathways=factor(x$pathways,ordered = TRUE,levels = x$pathways)
x=na.omit(x)

#Create plot
cv_paths_p=ggplot(x, aes(y=pathways, x=power, color=regulation, size=min_intra_STRONG)) +
  geom_point() + theme_bw() + 
  scale_color_manual(breaks = c("activated", "inhibited"), values=c("red", "blue")) +
  labs(x="PSN's Separability Power", y="Pathway specific PSNs", 
       color="Regulation Type", size="PSN's Class\ncohesion") +
  theme(text = element_text(size=8)) +
  scale_size(range = c(0, 2))

#Visualize
cv_paths_p

```

# Inference

We now introduce external datasets with different patients.
We combine the datasets (info and count matrices).
We define the IDs of the patients previously used as training and the new ones to be predicted.
We feed the prepared data to the function infer_new_data.

```{r inference}
counts1=cll_l[[1]]$counts
info1_df=cll_l[[1]]$info

counts2=cll_l[[2]]$counts
info2_df=cll_l[[2]]$info

counts3=cll_l[[3]]$counts
info3_df=cll_l[[3]]$info

#Assemble old and new data which patients' class must be infer
info=rbind(info4_df,info1_df,info2_df,info3_df)
gex=cbind(counts4,counts1,counts2,counts3)

#Prepare the run's data to predict the class of specifically the new patients
user_sets=list()
user_sets[[1]]=list(train=info4_df$ID,test=c(info1_df$ID,info2_df,info3_df$ID))

data_l=infer_new_data(info, 
                      groups_name=groups,
                      gex=gex,
                      tax_id=tax_id, 
                      user_sets=user_sets, 
                      data_l=data_l,
                      n_cores=n_cores)

#Save results
qsave(data_l,file = out_res_path, nthreads = n_cores)
```

# Inference results

We watch the predictions made for the new patients

```{r inference results, results='asis'}
#Info dataframe including the patients meta-information
new_pats_indxs=grep("CLL[1-3]",rownames(data_l$inference$run1$testing$info))
knitr::kable(data_l$inference$run1$testing$info[new_pats_indxs,])
```

We watch which pathway specific PSN has been used to predict

```{r inference results2, results='asis'}
knitr::kable(data_l$inference$performances$perfsXpathway_dfs)
```

We produce the plot of the performances based on the pathway specific PSNs which have been used to predict

```{r inference performances, out.width = "100%", fig.align = "center"}
#Prepare data about classification performances ----
#Extract and format the classification performance of the GCN with each PSN
perfs=data_l$inference$performances$perfsXpathway_dfs
perfs$method="StellarPath GCN"

#Combine it with the Ensembl performance
ens_perfs=apply(data_l$inference$performances$performances[,3:6],2,as.numeric)
ens_perfs=rbind(ens_perfs,ens_perfs)
ens_perfs1=perfs[1:nrow(ens_perfs),]
ens_perfs1[,c(1,2,3,4,9,10,11)]=NA
ens_perfs1[,5:8]=ens_perfs
ens_perfs1$method="StellarPath Ensemble"
perfs=rbind(perfs,ens_perfs1)
perfs$dataset="CLL"

#Prepare the dataframe for the plot
ord_methods=c("StellarPath GCN","StellarPath Ensemble")
perfs$method <- factor(perfs$method ,levels = ord_methods, ordered = TRUE)

#Plot
inf_perf_p=ggplot(perfs, aes(x = dataset, y = test_mcc, fill = method, color = method, size = method)) +
  geom_violin(scale = "width", position = position_dodge(width = 1)) +
  scale_color_manual(values = c("grey30", "#19E82B")) + 
  scale_fill_manual(values = c('#f6b45e','#19E82B')) +
  scale_size_manual(values = c(0.1, 1.5)) +
  theme(text = element_text(size = 8)) + theme_bw() + 
  labs(y = "MCC", x = "datasets") +
  facet_grid(~ dataset, scales = "free") +
  theme(axis.ticks.x = element_blank(), axis.text.x = element_blank()) +
  ylim(0.5, 1) + 
  stat_summary(fun.y = mean, mult = 1,
               geom = "pointrange", color = "black",
               position = position_dodge2(preserve = "single", 1, padding = 0.1), size = 0.02)

#Print
inf_perf_p
```

We plot and analyse the PSN of the B CELL RECEPTOR SIGNALING PATHWAY upregulated in UM with all the patients

```{r inference PSN, out.width = "100%", fig.align = "center"}

#Get the pathway's data
data2plot=get_pathway_data(data_l$inference,path2path = "enrichment$omics$gex$pathway_analysis$top_pathways_l$B CELL RECEPTOR SIGNALING PATHWAY")
#Get the info and PSN
info_inf=data_l$inference$run1$testing$info
PSN=data2plot$PSN
#We re-label the patients according to their dataset of origin (they have been anonymized by StellarPath)
colnames(PSN)=mapvalues(colnames(PSN),info_inf$IDs,rownames(info_inf))
info_inf$IDs=rownames(info_inf)
#Plot
PSN_plot=plot_PSN(info_inf, PSN, edge_threshold = 0.6, k_clusters = 10, GLratio=3, file_path = "CLL")
#Subgroup of nodes
PSN_subs=utils::stack(PSN_plot$names_in_k_l)
```

We export plots and results

```{r save all results}
#Save
usage_plot = ggpubr::ggarrange(cv_paths_p, inf_perf_p, labels = c("A", "B"), ncol = 1, nrow = 2)

ggsave(filename=out_plot_path, plot=usage_plot, 
       width = 170, height=130, units="mm", 
       dpi = 600, version="1.5")
ggsave(filename=gsub("pdf","png",out_plot_path), plot=usage_plot, 
       width = 170, height=130, units="mm", 
       dpi = 600)

#Report all the info
wr_l=list()
#Pathways found during cv training and testing
wr_l[["CLL_pathways"]]=data_l$enrichment$pathway_analysis$top_pathways_df
#Performance of the pathways used for the inference
wr_l[["CLL_perfs"]]=data_l$inference$performances$perfsXpathway_dfs
#Likelihood of how many pathway-specific PSNs/GCN predicted correctly each patient
wr_l[["CLL_likelihood"]]=data_l$inference$run1$testing$info
#Subnodes in the PSN
wr_l[["PSN_data"]]=PSN_subs
#Write
writexl::write_xlsx(wr_l, path = out_perfs_path)
```
